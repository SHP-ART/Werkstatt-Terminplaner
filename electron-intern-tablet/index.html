<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Werkstatt - Team-√úbersicht</title>
  <style>
    /* ========== RESET & GRUNDLAGEN ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #ffffff;
      --secondary: #f5f5f5;
      --accent: #1976d2;
      --highlight: #e94560;
      --text: #333333;
      --text-muted: #666666;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --card-bg: #ffffff;
      --card-border: #e0e0e0;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f0f2f5;
      color: var(--text);
      display: flex;
      flex-direction: column;
    }

    /* ========== HEADER ========== */
    .header {
      background: #ffffff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--accent);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }

    .header-title {
      font-size: 1.4em;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-time {
      font-size: 1.6em;
      font-weight: 300;
      color: var(--highlight);
    }

    .header-date {
      font-size: 0.9em;
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .btn-header {
      background: var(--accent);
      color: #ffffff;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95em;
      transition: all 0.2s;
    }

    .btn-header:hover {
      background: #1565c0;
    }

    /* ========== DISPLAY OFF OVERLAY ========== */
    #displayOffOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000000;
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: #333;
    }

    #displayOffOverlay.active {
      display: flex;
    }

    .display-off-icon {
      font-size: 4em;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .display-off-text {
      font-size: 1.5em;
      opacity: 0.3;
    }

    /* ========== MAIN CONTENT ========== */
    .main-content {
      flex: 1;
      padding: 20px 30px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ========== TEAM GRID - 2x2 Layout ========== */
    .team-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 20px;
      min-height: 0;
      overflow: hidden;
    }

    /* ========== PERSON KACHEL ========== */
    .person-kachel {
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--card-border);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .person-kachel.lehrling {
      border-left: 4px solid #9c27b0;
    }

    .person-kachel:not(.lehrling) {
      border-left: 4px solid #2196f3;
    }

    .person-header {
      padding: 10px 15px;
      background: #f8f9fa;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .person-name {
      font-size: 1.1em;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .person-icon {
      font-size: 1.3em;
    }

    .person-badge {
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.75em;
      font-weight: 500;
    }

    .person-badge.frei {
      background: var(--success);
      color: white;
    }

    .person-badge.in-arbeit {
      background: var(--warning);
      color: #333;
    }

    .person-badge.pause {
      background: var(--accent);
      color: white;
    }

    .person-arbeitszeit {
      padding: 8px 15px;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9em;
      flex-shrink: 0;
    }

    .arbeitszeit-label {
      color: #1565c0;
      font-weight: 500;
    }

    .arbeitszeit-wert {
      color: #0d47a1;
      font-weight: 600;
      font-family: 'Courier New', monospace;
      font-size: 1.05em;
    }

    .person-body {
      padding: 12px;
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      min-height: 0;
    }

    /* ========== AUFTRAG INFO ========== */
    .auftrag-info {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      border-left: 3px solid var(--highlight);
    }

    .auftrag-label {
      font-size: 0.8em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .auftrag-nr {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--highlight);
    }

    .auftrag-kunde {
      font-size: 0.95em;
      margin-top: 3px;
    }

    .auftrag-kennzeichen {
      font-size: 0.9em;
      color: var(--text-muted);
      font-family: monospace;
    }

    .auftrag-arbeit {
      font-size: 0.85em;
      color: var(--text-muted);
      margin-top: 4px;
      font-style: italic;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ========== ZEIT INFO ========== */
    .zeit-info {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin: 8px 0;
    }

    .zeit-item {
      text-align: center;
      padding: 6px;
      background: #f0f2f5;
      border-radius: 6px;
    }

    .zeit-label {
      font-size: 0.7em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .zeit-value {
      font-size: 1em;
      font-weight: 600;
      color: var(--accent);
    }

    .zeit-value.ueberzogen {
      color: var(--danger);
    }

    /* ========== FORTSCHRITT ========== */
    .fortschritt-container {
      margin-top: 8px;
    }

    .fortschritt-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }

    .fortschritt-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success) 0%, var(--warning) 70%, var(--danger) 100%);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .fortschritt-fill.ueberzogen {
      background: var(--danger);
    }

    .fortschritt-text {
      display: flex;
      justify-content: space-between;
      font-size: 0.75em;
      color: var(--text-muted);
      margin-top: 3px;
    }

    /* ========== N√ÑCHSTER AUFTRAG ========== */
    .naechster-auftrag {
      margin-top: auto;
      padding: 8px;
      background: #e8f5e9;
      border-radius: 6px;
      border-left: 3px solid var(--success);
    }

    .naechster-label {
      font-size: 0.75em;
      color: var(--success);
      margin-bottom: 3px;
    }

    .naechster-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85em;
    }

    /* ========== LEERER ZUSTAND ========== */
    .leer-zustand {
      text-align: center;
      padding: 15px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .leer-icon {
      font-size: 2em;
      margin-bottom: 5px;
    }

    .leer-text {
      color: var(--text-muted);
      font-size: 0.95em;
    }

    /* ========== BERUFSSCHULE ========== */
    .schule-info {
      text-align: center;
      padding: 15px;
      background: #f3e5f5;
      border-radius: 8px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .schule-icon {
      font-size: 2em;
      margin-bottom: 5px;
    }

    /* ========== TABLET BUTTONS ========== */
    .tablet-buttons {
      display: flex;
      gap: 8px;
      padding: 0 15px 10px 15px;
      flex-wrap: wrap;
    }

    .tablet-btn {
      flex: 1;
      min-width: 120px;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .tablet-btn-confirm {
      background: var(--success);
      color: white;
    }

    .tablet-btn-confirm:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }

    .tablet-btn-complete {
      background: var(--accent);
      color: white;
    }

    .tablet-btn-complete:hover {
      background: #1565c0;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(25, 118, 210, 0.3);
    }

    .tablet-btn-pause {
      background: var(--warning);
      color: #333;
    }

    .tablet-btn-pause:hover {
      background: #e0a800;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    }

    .tablet-btn-pause.au√üerhalb {
      background: #ffeaa7;
      border: 2px solid var(--warning);
    }

    .tablet-btn-pause.aktiv {
      background: #fdcb6e;
      cursor: not-allowed;
      opacity: 0.8;
    }

    .tablet-btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* Verschobene Termine */
    .termin-verschoben {
      border: 2px solid var(--warning);
      background: #fff8e1;
    }

    .termin-verspaetet {
      border: 2px solid var(--danger);
      background: #ffebee;
    }

    .badge-verschoben, .badge-verspaetet {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75em;
      font-weight: 600;
      margin-left: 6px;
    }

    .badge-verschoben {
      background: var(--warning);
      color: #333;
    }

    .badge-verspaetet {
      background: var(--danger);
      color: white;
    }

    /* Toast-Animationen */
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .schule-text {
      color: #7b1fa2;
      font-size: 0.95em;
    }

    /* ========== LOADING ========== */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      grid-column: 1 / -1;
      grid-row: 1 / -1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #e0e0e0;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========== ERROR ========== */
    .error-message {
      background: rgba(220, 53, 69, 0.1);
      border: 1px solid var(--danger);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      color: var(--danger);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* ========== KEINE DATEN / ERROR ========== */
    .keine-daten,
    .error-message {
      grid-column: 1 / -1;
      grid-row: 1 / -1;
    }

    .keine-daten {
      text-align: center;
      padding: 30px;
      color: var(--text-muted);
      font-size: 1.1em;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 1024px) {
      .team-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .main-content {
        padding: 15px 20px;
      }
    }

    @media (max-width: 768px) {
      .team-grid {
        grid-template-columns: 1fr;
        grid-template-rows: auto;
      }

      .header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
        padding: 8px 15px;
      }

      .header-title {
        font-size: 1.2em;
      }

      .header-time {
        font-size: 1.4em;
      }
    }

  </style>
</head>
<body>
  <!-- Display Off Overlay -->
  <div id="displayOffOverlay">
    <div class="display-off-icon">üåô</div>
    <div class="display-off-text">Display ist au√üerhalb der Betriebszeiten</div>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="header-title">
      <span>üë∑ Team-√úbersicht</span>
      <span class="header-date" id="headerDate">-</span>
    </div>
    <div class="header-time" id="headerTime">--:--</div>
    <div class="header-actions">
      <button class="btn-header" id="btnRefresh" title="Aktualisieren (F5)">üîÑ Aktualisieren</button>
      <button class="btn-header" id="btnSettings" title="Einstellungen">‚öôÔ∏è</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div id="teamGrid" class="team-grid">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>Lade...</p>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: var(--card-bg); padding: 30px; border-radius: 16px; max-width: 550px; width: 90%;">
      <h3 style="margin-bottom: 20px;">‚öôÔ∏è Einstellungen</h3>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px;">Backend-URL:</label>
        <input type="text" id="settingsBackendUrl" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--card-border); background: var(--primary); color: var(--text);">
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px;">Auto-Refresh (Sekunden):</label>
        <input type="number" id="settingsRefreshInterval" min="10" max="300" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--card-border); background: var(--primary); color: var(--text);">
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
          <input type="checkbox" id="settingsFullscreen" style="width: 18px; height: 18px;">
          <span>Vollbild beim Start</span>
        </label>
      </div>

      <div style="margin-bottom: 15px;" id="autostartOption">
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
          <input type="checkbox" id="settingsAutostart" style="width: 18px; height: 18px;">
          <span>Autostart bei Windows-Anmeldung</span>
        </label>
      </div>

      <div style="margin-bottom: 15px; padding: 15px; background: rgba(0,0,0,0.1); border-radius: 8px;">
        <div style="font-weight: 600; margin-bottom: 10px;">üåô Display-Timer</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Ausschalten um:</label>
            <input type="time" id="settingsDisplayOffTime" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--card-border); background: var(--primary); color: var(--text);">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Einschalten um:</label>
            <input type="time" id="settingsDisplayOnTime" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--card-border); background: var(--primary); color: var(--text);">
          </div>
        </div>
        <div style="font-size: 0.8em; color: var(--text-muted); margin-top: 8px;">
          ‚ÑπÔ∏è Display wird automatisch schwarz geschaltet au√üerhalb dieser Zeiten. Data-Refresh l√§uft weiter.
        </div>
      </div>

      <div style="margin-bottom: 20px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 0.85em;" id="configPathInfo">
        <div style="color: var(--text-muted); margin-bottom: 5px;">üìÅ Konfigurations-Datei:</div>
        <div id="configPathDisplay" style="font-family: monospace; word-break: break-all; color: var(--accent);">-</div>
      </div>

      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="btnSettingsCancel" style="padding: 10px 20px; border-radius: 8px; border: none; background: var(--accent); color: var(--text); cursor: pointer;">Abbrechen</button>
        <button id="btnSettingsSave" style="padding: 10px 20px; border-radius: 8px; border: none; background: var(--success); color: white; cursor: pointer;">Speichern</button>
      </div>
    </div>
  </div>

  <script>
    // ========== KONFIGURATION ==========
    let CONFIG = {
      backendUrl: 'http://localhost:3000',
      refreshInterval: 30,
      fullscreen: true,
      autostart: false,
      displayOffTime: '18:10',
      displayOnTime: '07:30'
    };

    // Lade gespeicherte Einstellungen
    const savedConfig = localStorage.getItem('werkstatt-intern-config');
    if (savedConfig) {
      try {
        CONFIG = { ...CONFIG, ...JSON.parse(savedConfig) };
      } catch (e) {}
    }

    // Lade Electron-Konfiguration falls vorhanden
    async function initConfig() {
      if (window.electronAPI) {
        try {
          const electronConfig = await window.electronAPI.getConfig();
          CONFIG = { ...CONFIG, ...electronConfig };
          isElectron = true;
          console.log('Electron-Konfiguration geladen:', CONFIG);

          // Display-Status-Listener registrieren
          window.electronAPI.onDisplayStatus((shouldBeOff) => {
            const overlay = document.getElementById('displayOffOverlay');
            if (overlay) {
              if (shouldBeOff) {
                overlay.classList.add('active');
              } else {
                overlay.classList.remove('active');
              }
            }
          });
        } catch (e) {
          console.warn('Keine Electron-API verf√ºgbar');
        }
      }

      // Lade Tablet-Einstellungen vom Server
      await loadTabletEinstellungenFromServer();
    }

    // ========== TABLET-EINSTELLUNGEN VOM SERVER ==========
    async function loadTabletEinstellungenFromServer() {
      try {
        const response = await fetch(`${CONFIG.backendUrl}/api/tablet/einstellungen`);
        if (response.ok) {
          const einstellungen = await response.json();
          
          // Server-Einstellungen √ºberschreiben lokale Defaults
          if (einstellungen.display_einschaltzeit) {
            CONFIG.displayOnTime = einstellungen.display_einschaltzeit;
          }
          if (einstellungen.display_ausschaltzeit) {
            CONFIG.displayOffTime = einstellungen.display_ausschaltzeit;
          }
          
          // Manueller Status hat Vorrang
          if (einstellungen.manueller_display_status) {
            if (einstellungen.manueller_display_status === 'an') {
              // Display sofort einschalten
              const overlay = document.getElementById('displayOffOverlay');
              if (overlay) overlay.classList.remove('active');
              // Informiere Electron-Main-Process: Display EINSCHALTEN
              if (window.electronAPI && window.electronAPI.setDisplayManual) {
                window.electronAPI.setDisplayManual(false);
              }
            } else if (einstellungen.manueller_display_status === 'aus') {
              // Display sofort ausschalten
              const overlay = document.getElementById('displayOffOverlay');
              if (overlay) overlay.classList.add('active');
              // Informiere Electron-Main-Process: Display AUSSCHALTEN
              if (window.electronAPI && window.electronAPI.setDisplayManual) {
                window.electronAPI.setDisplayManual(true);
              }
            }
            // Bei 'auto' wird die normale Zeitsteuerung verwendet
          }
          
          console.log('‚úÖ Tablet-Einstellungen vom Server geladen:', einstellungen);
          
          // Informiere Electron-Main-Process √ºber neue Zeiten
          if (window.electronAPI && window.electronAPI.updateDisplayTimes) {
            window.electronAPI.updateDisplayTimes({
              displayOffTime: CONFIG.displayOffTime,
              displayOnTime: CONFIG.displayOnTime
            });
          }
        } else {
          console.warn('‚ö†Ô∏è Keine Tablet-Einstellungen vom Server verf√ºgbar, nutze lokale Konfiguration');
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Fehler beim Laden der Tablet-Einstellungen vom Server:', error.message);
        console.log('‚Üí Fallback: Nutze lokale Konfiguration');
      }
    }

    // Aktualisiere Tablet-Einstellungen regelm√§√üig (alle 30 Sekunden)
    setInterval(() => {
      loadTabletEinstellungenFromServer();
    }, 30000);

    // ========== API SERVICE ==========
    const ApiService = {
      async get(endpoint) {
        const response = await fetch(`${CONFIG.backendUrl}/api${endpoint}`);
        if (!response.ok) throw new Error(`API Fehler: ${response.status}`);
        return response.json();
      },
      async put(endpoint, data) {
        const response = await fetch(`${CONFIG.backendUrl}/api${endpoint}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error(`API Fehler: ${response.status}`);
        return response.json();
      },
      async post(endpoint, data) {
        const response = await fetch(`${CONFIG.backendUrl}/api${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error(`API Fehler: ${response.status}`);
        return response.json();
      }
    };

    // ========== HILFSFUNKTIONEN ==========
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDateLocal(date) {
      const d = date instanceof Date ? date : new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatMinutesToHours(minuten) {
      if (!minuten || minuten <= 0) return '0h';
      const h = Math.floor(minuten / 60);
      const m = Math.round(minuten % 60);
      if (h === 0) return `${m}min`;
      if (m === 0) return `${h}h`;
      return `${h}h ${m}min`;
    }

    function getKalenderwoche(dateStr) {
      const date = new Date(dateStr);
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
      return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    }

    function isLehrlingInBerufsschule(lehrling, datum) {
      if (!lehrling || !lehrling.berufsschul_wochen || !datum) {
        return false;
      }
      // berufsschul_wochen ist ein String: "1,5,9,13" oder "1, 5, 9, 13"
      const kw = getKalenderwoche(datum);
      const schulwochen = lehrling.berufsschul_wochen.split(',')
        .map(w => parseInt(w.trim(), 10))
        .filter(w => !isNaN(w));
      return schulwochen.includes(kw);
    }

    // ========== ZEIT-BERECHNUNGEN ==========
    function getEffektiveArbeitszeit(termin) {
      if (termin.status === 'abgeschlossen' && termin.tatsaechliche_zeit) {
        return termin.tatsaechliche_zeit;
      }

      if (termin.arbeitszeiten_details) {
        try {
          const details = typeof termin.arbeitszeiten_details === 'string'
            ? JSON.parse(termin.arbeitszeiten_details)
            : termin.arbeitszeiten_details;

          let summe = 0;
          for (const [key, value] of Object.entries(details)) {
            if (key.startsWith('_')) continue;
            if (typeof value === 'number') summe += value;
            else if (typeof value === 'object' && value.zeit) summe += value.zeit;
          }
          if (summe > 0) return summe;
        } catch (e) {}
      }

      return termin.geschaetzte_zeit || 60;
    }

    function getEffektiveArbeitszeitMitFaktoren(termin, person, isLehrling, globaleNebenzeit) {
      if (termin.status === 'abgeschlossen' && termin.tatsaechliche_zeit) {
        return termin.tatsaechliche_zeit;
      }

      let basisZeit = getEffektiveArbeitszeit(termin);

      // Globale Nebenzeit
      if (globaleNebenzeit > 0) {
        basisZeit = basisZeit * (1 + globaleNebenzeit / 100);
      }

      // Aufgabenbew√§ltigung f√ºr Lehrlinge
      if (isLehrling && person && person.aufgabenbewaeltigung_prozent &&
          person.aufgabenbewaeltigung_prozent !== 100) {
        basisZeit = basisZeit * (person.aufgabenbewaeltigung_prozent / 100);
      }

      return Math.round(basisZeit);
    }

    function berechneEndzeit(termin, person, isLehrling, globaleNebenzeit) {
      if (termin.status === 'abgeschlossen' && termin.fertigstellung_zeit) {
        // Formatiere ISO-Timestamp zu HH:MM
        try {
          const datum = new Date(termin.fertigstellung_zeit);
          const stunden = String(datum.getHours()).padStart(2, '0');
          const minuten = String(datum.getMinutes()).padStart(2, '0');
          return `${stunden}:${minuten}`;
        } catch (e) {
          // Falls kein ISO-Timestamp, gib direkt zur√ºck (z.B. schon "10:00" Format)
          return termin.fertigstellung_zeit;
        }
      }

      const startzeit = termin.startzeit || termin.bring_zeit;
      if (!startzeit) return '--:--';

      const dauer = getEffektiveArbeitszeitMitFaktoren(termin, person, isLehrling, globaleNebenzeit);
      const [h, m] = startzeit.split(':').map(Number);
      const startMinuten = h * 60 + m;
      let gesamtMinuten = startMinuten + dauer;

      // Pausenber√ºcksichtigung (6h-Regel beachten)
      if (person) {
        const wochenStunden = person.wochenarbeitszeit_stunden || person.arbeitsstunden_pro_tag * (person.arbeitstage_pro_woche || 5);
        const arbeitstage = person.arbeitstage_pro_woche || 5;
        const taeglicheStunden = wochenStunden / arbeitstage;

        // Nur bei >= 6h Arbeitszeit pro Tag Pause ber√ºcksichtigen
        if (taeglicheStunden >= 6) {
          const pauseStart = person.mittagspause_start;
          const pauseDauer = person.pausenzeit_minuten || 30;

          if (pauseStart && pauseDauer > 0) {
            const [pauseH, pauseM] = pauseStart.split(':').map(Number);
            const pausenStart = pauseH * 60 + pauseM;
            const pausenEnde = pausenStart + pauseDauer;
            const endMinutenOhnePause = startMinuten + dauer;

            // Fall 1: Arbeit beginnt vor Pause und endet nach Pause-Start
            if (startMinuten < pausenStart && endMinutenOhnePause > pausenStart) {
              gesamtMinuten += pauseDauer;
            }
            // Fall 2: Arbeit beginnt w√§hrend der Pause
            else if (startMinuten >= pausenStart && startMinuten < pausenEnde) {
              const verschiebung = pausenEnde - startMinuten;
              gesamtMinuten += verschiebung;
            }
          }
        }
      }

      const endH = Math.floor(gesamtMinuten / 60);
      const endM = gesamtMinuten % 60;

      return `${String(endH).padStart(2, '0')}:${String(endM).padStart(2, '0')}`;
    }

    /**
     * Pr√ºft ob eine Person aktuell in der Mittagspause ist
     * Ber√ºcksichtigt die 6h-Regel: Pause nur bei >= 6h Arbeitszeit pro Tag
     */
    function istPersonAktuellInPause(person, aktuelleZeit = null) {
      if (!person) return false;

      // Berechne t√§gliche Arbeitszeit
      const wochenStunden = person.wochenarbeitszeit_stunden || person.arbeitsstunden_pro_tag * (person.arbeitstage_pro_woche || 5);
      const arbeitstage = person.arbeitstage_pro_woche || 5;
      const taeglicheStunden = wochenStunden / arbeitstage;

      // 6h-Regel: Keine Pause bei unter 6h Arbeitszeit pro Tag
      if (taeglicheStunden < 6) {
        return false;
      }

      // Pr√ºfe ob Pausenzeiten definiert sind
      const pauseStart = person.mittagspause_start;
      const pauseDauer = person.pausenzeit_minuten || 30;

      if (!pauseStart || pauseDauer <= 0) {
        return false;
      }

      // Aktuelle Zeit bestimmen
      let jetztZeit = aktuelleZeit;
      if (!jetztZeit) {
        const jetzt = new Date();
        const h = jetzt.getHours();
        const m = jetzt.getMinutes();
        jetztZeit = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      }

      // Berechne Pause-Ende
      const [pauseH, pauseM] = pauseStart.split(':').map(Number);
      const pauseStartMinuten = pauseH * 60 + pauseM;
      const pauseEndeMinuten = pauseStartMinuten + pauseDauer;
      const pauseEndeH = Math.floor(pauseEndeMinuten / 60);
      const pauseEndeM = pauseEndeMinuten % 60;
      const pauseEnde = `${String(pauseEndeH).padStart(2, '0')}:${String(pauseEndeM).padStart(2, '0')}`;

      // Pr√ºfe ob aktuelle Zeit innerhalb des Pausenfensters liegt
      return jetztZeit >= pauseStart && jetztZeit < pauseEnde;
    }

    function berechneRestzeit(termin, person, isLehrling, globaleNebenzeit) {
      const startzeit = termin.startzeit || termin.bring_zeit;
      if (!startzeit) return '--:--';

      const dauer = getEffektiveArbeitszeitMitFaktoren(termin, person, isLehrling, globaleNebenzeit);
      const [h, m] = startzeit.split(':').map(Number);
      const startDate = new Date();
      startDate.setHours(h, m, 0, 0);

      const verstricheneMinuten = (new Date() - startDate) / 1000 / 60;
      const restMinuten = dauer - verstricheneMinuten;

      if (restMinuten <= 0) {
        return `+${formatMinutesToHours(Math.abs(Math.round(restMinuten)))}`;
      }
      return `~${formatMinutesToHours(Math.round(restMinuten))}`;
    }

    function berechneFortschritt(termin, person, isLehrling, globaleNebenzeit) {
      const startzeit = termin.startzeit || termin.bring_zeit;
      if (!startzeit) return 0;

      const dauer = getEffektiveArbeitszeitMitFaktoren(termin, person, isLehrling, globaleNebenzeit);
      const [h, m] = startzeit.split(':').map(Number);
      const startDate = new Date();
      startDate.setHours(h, m, 0, 0);

      const verstricheneMinuten = (new Date() - startDate) / 1000 / 60;
      return Math.round(Math.max(0, (verstricheneMinuten / dauer) * 100));
    }

    // ========== TERMIN-ZUORDNUNG PR√úFEN ==========
    function isTerminFuerPerson(termin, personId, isLehrling) {
      if (isLehrling) {
        if (termin.lehrling_id == personId) return true;
      } else {
        if (termin.mitarbeiter_id == personId) return true;
      }

      if (termin.arbeitszeiten_details) {
        try {
          const details = typeof termin.arbeitszeiten_details === 'string'
            ? JSON.parse(termin.arbeitszeiten_details)
            : termin.arbeitszeiten_details;

          if (details._gesamt_mitarbeiter_id) {
            const gesamt = details._gesamt_mitarbeiter_id;
            if (isLehrling && gesamt.type === 'lehrling' && gesamt.id == personId) return true;
            if (!isLehrling && gesamt.type === 'mitarbeiter' && gesamt.id == personId) return true;
          }

          for (const key of Object.keys(details)) {
            if (key.startsWith('_')) continue;
            const entry = details[key];
            if (entry && typeof entry === 'object') {
              if (isLehrling && entry.lehrling_id == personId) return true;
              if (!isLehrling && entry.mitarbeiter_id == personId) return true;
            }
          }
        } catch (e) {}
      }

      return false;
    }

    // ========== BUTTON HANDLER ==========
    async function handleBestaetigen(personId, personTyp, terminId, kundeName) {
      try {
        const heute = formatDateLocal(new Date());
        
        // 1. Status auf in_arbeit setzen
        await ApiService.put(`/termine/${terminId}`, { status: 'in_arbeit' });
        
        // 2. Termine neu berechnen
        await ApiService.post('/termine/berechne-zeiten-neu', {
          personId,
          personTyp,
          datum: heute,
          startTerminId: terminId
        });
        
        // 3. UI aktualisieren
        await loadTeamUebersicht();
        
        // Erfolgs-Feedback
        showToast(`Auftrag best√§tigt: ${kundeName}`, 'success');
      } catch (error) {
        console.error('Fehler beim Best√§tigen:', error);
        showToast(`Fehler: ${error.message}`, 'error');
      }
    }

    async function handleBeenden(terminId, kundeName) {
      try {
        await ApiService.put(`/termine/${terminId}`, { 
          status: 'abgeschlossen',
          fertigstellung_zeit: new Date().toISOString()
        });
        
        await loadTeamUebersicht();
        showToast(`Auftrag abgeschlossen: ${kundeName}`, 'success');
      } catch (error) {
        console.error('Fehler beim Beenden:', error);
        showToast(`Fehler: ${error.message}`, 'error');
      }
    }

    // Map zum Tracken von laufenden Pause-Requests (verhindert Doppelklicks)
    const pauseStartInProgress = new Set();

    async function handlePauseStarten(personId, personTyp, datum, imZeitfenster) {
      // Pr√ºfe ob bereits ein Request f√ºr diese Person l√§uft
      const key = `${personTyp}_${personId}`;
      if (pauseStartInProgress.has(key)) {
        console.log('Pause-Start bereits in Bearbeitung, Request wird ignoriert');
        return;
      }

      try {
        // Wenn au√üerhalb des idealen Zeitfensters (nach der eingestellten Pausenzeit): Best√§tigung einholen
        if (!imZeitfenster) {
          const bestaetigung = confirm(
            '‚ö†Ô∏è Die Pausenzeit liegt nach der eingestellten Mittagspause.\n\n' +
            'M√∂chten Sie trotzdem die Pause starten?'
          );
          if (!bestaetigung) {
            console.log('Pause abgebrochen durch Benutzer');
            return; // Abbruch - keine weiteren Aktionen
          }
        }

        console.log('Starte Pause f√ºr:', { personId, personTyp, datum });
        
        // Markiere als "in Bearbeitung"
        pauseStartInProgress.add(key);
        
        await ApiService.post('/pause/starten', {
          personId,
          personTyp,
          datum
        });
        
        await loadTeamUebersicht();
        showToast('Pause gestartet', 'success');
      } catch (error) {
        console.error('Fehler beim Pause starten:', error);
        showToast(`Fehler: ${error.message}`, 'error');
      } finally {
        // Entferne "in Bearbeitung" Markierung
        pauseStartInProgress.delete(key);
      }
    }

    function showToast(message, type = 'info') {
      // Einfache Toast-Benachrichtigung
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease;
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    // ========== KACHEL RENDERN ==========
    function renderPersonKachel(person, alleTermine, typ, globaleNebenzeit, arbeitszeit) {
      const personId = person.id;
      const personName = person.name;
      const isLehrling = typ === 'lehrling';

      // Debug: Arbeitszeit-Parameter pr√ºfen
      console.log(`[renderPersonKachel] ${personName} (${typ}_${personId}):`, arbeitszeit);

      // Finde Termine f√ºr diese Person
      const personTermine = alleTermine.filter(t => isTerminFuerPerson(t, personId, isLehrling));
      console.log(`[DEBUG] ${personName}: ${personTermine.length} Termine gefunden`, personTermine);
      
      personTermine.sort((a, b) => {
        const zeitA = a.startzeit || a.bring_zeit || '23:59';
        const zeitB = b.startzeit || b.bring_zeit || '23:59';
        return zeitA.localeCompare(zeitB);
      });

      const jetzt = new Date();
      const jetztZeit = `${String(jetzt.getHours()).padStart(2, '0')}:${String(jetzt.getMinutes()).padStart(2, '0')}`;

      // Finde aktuellen Auftrag
      let aktuellerAuftrag = personTermine.find(t => t.status === 'in_arbeit');
      if (!aktuellerAuftrag) {
        aktuellerAuftrag = personTermine.find(t => {
          if (t.status === 'abgeschlossen' || t.status === 'storniert') return false;
          const startzeit = t.startzeit || t.bring_zeit;
          if (!startzeit) return false;
          // Verwende berechneEndzeit f√ºr korrekte Pausenber√ºcksichtigung
          const endzeit = berechneEndzeit(t, person, isLehrling, globaleNebenzeit);
          return startzeit <= jetztZeit && jetztZeit < endzeit;
        });
      }

      // Finde n√§chsten Auftrag (auch √ºberf√§llige offene Termine ber√ºcksichtigen!)
      const naechsterAuftrag = personTermine.find(t => {
        if (t === aktuellerAuftrag) return false;
        if (t.status === 'abgeschlossen' || t.status === 'storniert') return false;
        // Alle offenen/geplanten Termine als "n√§chsten" z√§hlen
        return true;
      });

      console.log(`[DEBUG] ${personName}: aktuellerAuftrag=`, aktuellerAuftrag, 'naechsterAuftrag=', naechsterAuftrag);

      // Pr√ºfe Berufsschule
      let inBerufsschule = false;
      if (isLehrling && person.berufsschul_wochen) {
        inBerufsschule = isLehrlingInBerufsschule(person, formatDateLocal(new Date()));
      }

      // Pr√ºfe Mittagspause (6h-Regel)
      const inPause = istPersonAktuellInPause(person, jetztZeit);
      
      console.log(`[DEBUG] ${personName}: inPause=${inPause}, inBerufsschule=${inBerufsschule}`);

      // Badge
      let badgeClass = 'frei';
      let badgeText = 'Frei';
      if (inPause) {
        badgeClass = 'pause';
        badgeText = 'üçΩÔ∏è Pause';
      } else if (inBerufsschule) {
        badgeClass = 'pause';
        badgeText = 'Berufsschule';
      } else if (aktuellerAuftrag) {
        badgeClass = 'in-arbeit';
        badgeText = 'In Arbeit';
      }

      // Body Content
      let bodyContent = '';

      if (inPause) {
        bodyContent = `
          <div class="schule-info">
            <div class="schule-icon">üçΩÔ∏è</div>
            <div class="schule-text">Mittagspause</div>
          </div>
        `;
      } else if (inBerufsschule) {
        bodyContent = `
          <div class="schule-info">
            <div class="schule-icon">üìö</div>
            <div class="schule-text">Heute in der Berufsschule</div>
          </div>
        `;
      } else if (aktuellerAuftrag) {
        const fortschritt = berechneFortschritt(aktuellerAuftrag, person, isLehrling, globaleNebenzeit);
        const restzeit = berechneRestzeit(aktuellerAuftrag, person, isLehrling, globaleNebenzeit);
        const isUeberzogen = fortschritt > 100;
        
        // Pr√ºfe verschoben und versp√§tet
        const istVerschoben = aktuellerAuftrag.verschoben_von_datum != null;
        const istVerspaetet = aktuellerAuftrag.endzeit_berechnet && aktuellerAuftrag.abholung_zeit && 
                              aktuellerAuftrag.endzeit_berechnet > aktuellerAuftrag.abholung_zeit;
        
        let badges = '';
        if (istVerschoben) badges += '<span class="badge-verschoben">üìÖ Verschoben</span>';
        if (istVerspaetet) badges += '<span class="badge-verspaetet">‚ö†Ô∏è Verz√∂gerung</span>';

        bodyContent = `
          <div class="auftrag-info ${istVerschoben ? 'termin-verschoben' : ''} ${istVerspaetet ? 'termin-verspaetet' : ''}">
            <div class="auftrag-label">üîß Aktueller Auftrag ${badges}</div>
            <div class="auftrag-nr">${escapeHtml(aktuellerAuftrag.termin_nr) || '-'}</div>
            <div class="auftrag-kunde">${escapeHtml(aktuellerAuftrag.kunde_name) || '-'}</div>
            <div class="auftrag-kennzeichen">${escapeHtml(aktuellerAuftrag.kennzeichen) || '-'}</div>
            <div class="auftrag-arbeit">${escapeHtml(aktuellerAuftrag.arbeit) || '-'}</div>
          </div>

          <div class="zeit-info">
            <div class="zeit-item">
              <div class="zeit-label">Beginn</div>
              <div class="zeit-value">${aktuellerAuftrag.startzeit || aktuellerAuftrag.bring_zeit || '--:--'}</div>
            </div>
            <div class="zeit-item">
              <div class="zeit-label">Fertig ca.</div>
              <div class="zeit-value">${berechneEndzeit(aktuellerAuftrag, person, isLehrling, globaleNebenzeit)}</div>
            </div>
            <div class="zeit-item">
              <div class="zeit-label">Rest</div>
              <div class="zeit-value ${isUeberzogen ? 'ueberzogen' : ''}">${restzeit}</div>
            </div>
          </div>

          <div class="fortschritt-container">
            <div class="fortschritt-bar">
              <div class="fortschritt-fill ${isUeberzogen ? 'ueberzogen' : ''}" style="width: ${Math.min(fortschritt, 100)}%"></div>
            </div>
            <div class="fortschritt-text">
              <span>Fortschritt</span>
              <span>${Math.min(fortschritt, 150)}%</span>
            </div>
          </div>

          ${naechsterAuftrag ? `
            <div class="naechster-auftrag">
              <div class="naechster-label">üìã Danach:</div>
              <div class="naechster-info">
                <span>${escapeHtml(naechsterAuftrag.kunde_name) || '-'} ‚Ä¢ ${escapeHtml(naechsterAuftrag.kennzeichen) || '-'}</span>
                <span>${naechsterAuftrag.startzeit || naechsterAuftrag.bring_zeit || '--:--'}</span>
              </div>
            </div>
          ` : ''}
        `;
      } else if (naechsterAuftrag) {
        bodyContent = `
          <div class="leer-zustand">
            <div class="leer-icon">‚òï</div>
            <div class="leer-text">Aktuell kein Auftrag</div>
          </div>

          <div class="naechster-auftrag">
            <div class="naechster-label">‚è∞ N√§chster Auftrag:</div>
            <div class="auftrag-info" style="border-left-color: var(--success);">
              <div class="auftrag-nr">${escapeHtml(naechsterAuftrag.termin_nr) || '-'}</div>
              <div class="auftrag-kunde">${escapeHtml(naechsterAuftrag.kunde_name) || '-'}</div>
              <div class="auftrag-kennzeichen">${escapeHtml(naechsterAuftrag.kennzeichen) || '-'}</div>
            </div>
            <div class="zeit-info" style="margin-top: 10px;">
              <div class="zeit-item">
                <div class="zeit-label">Start</div>
                <div class="zeit-value">${naechsterAuftrag.startzeit || naechsterAuftrag.bring_zeit || '--:--'}</div>
              </div>
              <div class="zeit-item">
                <div class="zeit-label">Dauer</div>
                <div class="zeit-value">${formatMinutesToHours(getEffektiveArbeitszeitMitFaktoren(naechsterAuftrag, person, isLehrling, globaleNebenzeit))}</div>
              </div>
            </div>
          </div>
        `;
      } else {
        bodyContent = `
          <div class="leer-zustand">
            <div class="leer-icon">üéâ</div>
            <div class="leer-text">Keine Auftr√§ge f√ºr heute</div>
          </div>
        `;
      }

      // Arbeitszeit nur anzeigen, wenn Person nicht abwesend ist (nicht in Pause, nicht in Berufsschule)
      const zeigeArbeitszeit = !inPause && !inBerufsschule;

      // Button-Container (Toggle & Pause)
      let buttonsHtml = '';
      
      // Bestimme den Termin, f√ºr den Buttons angezeigt werden sollen
      const terminMitButtons = aktuellerAuftrag || naechsterAuftrag;
      
      // 1. Toggle-Button: Best√§tigen/Beenden
      if (terminMitButtons && !inPause && !inBerufsschule) {
        if (terminMitButtons.status === 'geplant' || terminMitButtons.status === 'offen') {
          // Best√§tigen-Button (f√ºr geplant oder offen)
          buttonsHtml += `
            <button class="tablet-btn tablet-btn-confirm" 
                    onclick="handleBestaetigen(${personId}, '${typ}', ${terminMitButtons.id}, '${escapeHtml(terminMitButtons.kunde_name)}')">
              ‚úÖ Best√§tigen
            </button>
          `;
        } else if (terminMitButtons.status === 'in_arbeit') {
          // Beenden-Button
          buttonsHtml += `
            <button class="tablet-btn tablet-btn-complete" 
                    onclick="handleBeenden(${terminMitButtons.id}, '${escapeHtml(terminMitButtons.kunde_name)}')">
              üèÅ Beenden
            </button>
          `;
        }
      }

      // 2. Pause-Button mit Timer
      if (person.pause_tracking_aktiv) {
        // Aktive Pause mit verbleibender Zeit
        const verbleibendeMin = person.pause_verbleibende_minuten || 0;
        buttonsHtml += `
          <button class="tablet-btn tablet-btn-pause aktiv" disabled>
            üçΩÔ∏è Pause (${verbleibendeMin} Min.)
          </button>
        `;
      } else if (!inPause && !inBerufsschule) {
        // Pause-Button immer anzeigen (auch ohne Termine) wenn 1h vor Pausenzeit
        const jetztMinuten = jetzt.getHours() * 60 + jetzt.getMinutes();
        const [pauseH, pauseM] = (person.mittagspause_start || '12:00').split(':').map(Number);
        const pausenStartMinuten = pauseH * 60 + pauseM;
        const zeitfensterMin = pausenStartMinuten - 60; // 1h vor Pausenzeit
        
        // Button nur anzeigen wenn 1h vor Pausenzeit oder sp√§ter, aber vor 1h nach Pausenzeit
        const imAnzeigeZeitraum = jetztMinuten >= zeitfensterMin;
        const zeitfensterMax = pausenStartMinuten + 60; // Warnung wenn zu sp√§t
        const imIdealemZeitfenster = jetztMinuten >= zeitfensterMin && jetztMinuten <= pausenStartMinuten;

        if (imAnzeigeZeitraum) {
          buttonsHtml += `
            <button class="tablet-btn tablet-btn-pause ${imIdealemZeitfenster ? '' : 'au√üerhalb'}" 
                    onclick="handlePauseStarten(${personId}, '${typ}', '${formatDateLocal(new Date())}', ${imIdealemZeitfenster})">
              üçΩÔ∏è Pause starten
            </button>
          `;
        }
      }

      return `
        <div class="person-kachel ${isLehrling ? 'lehrling' : ''}">
          <div class="person-header">
            <div class="person-name">
              <span class="person-icon">${isLehrling ? 'üéì' : 'üë∑'}</span>
              <span>${escapeHtml(personName)}</span>
            </div>
            <div class="person-badge ${badgeClass}">${badgeText}</div>
          </div>
          ${zeigeArbeitszeit && arbeitszeit && arbeitszeit.arbeitszeit_start && arbeitszeit.arbeitszeit_ende ? `
          <div class="person-arbeitszeit">
            <span class="arbeitszeit-label">‚è∞ Arbeitszeit:</span>
            <span class="arbeitszeit-wert">${arbeitszeit.arbeitszeit_start} - ${arbeitszeit.arbeitszeit_ende}</span>
          </div>
          ` : ''}
          ${buttonsHtml ? `<div class="tablet-buttons">${buttonsHtml}</div>` : ''}
          <div class="person-body">
            ${bodyContent}
          </div>
        </div>
      `;
    }

    // ========== DATEN LADEN ==========
    async function loadTeamUebersicht() {
      const teamGrid = document.getElementById('teamGrid');

      try {
        const heute = formatDateLocal(new Date());
        const [mitarbeiter, lehrlinge, termine, einstellungen, aktivePausen] = await Promise.all([
          ApiService.get('/mitarbeiter'),
          ApiService.get('/lehrlinge'),
          ApiService.get(`/termine?datum=${heute}`),
          ApiService.get('/einstellungen/werkstatt'),
          ApiService.get('/pause/aktive')
        ]);

        const globaleNebenzeit = einstellungen?.nebenzeit_prozent || 0;
        const aktiveMitarbeiter = mitarbeiter.filter(m => m.aktiv === 1);
        const aktiveLehrlinge = lehrlinge.filter(l => l.aktiv === 1);

        // Merge Pausen-Daten in Person-Objekte
        const pausenMap = {};
        (aktivePausen || []).forEach(pause => {
          const key = pause.mitarbeiter_id 
            ? `mitarbeiter_${pause.mitarbeiter_id}` 
            : `lehrling_${pause.lehrling_id}`;
          pausenMap[key] = {
            pause_tracking_aktiv: true,
            pause_verbleibende_minuten: pause.verbleibende_minuten || 0
          };
        });

        aktiveMitarbeiter.forEach(m => {
          const pauseInfo = pausenMap[`mitarbeiter_${m.id}`];
          if (pauseInfo) {
            m.pause_tracking_aktiv = pauseInfo.pause_tracking_aktiv;
            m.pause_verbleibende_minuten = pauseInfo.pause_verbleibende_minuten;
          }
        });

        aktiveLehrlinge.forEach(l => {
          const pauseInfo = pausenMap[`lehrling_${l.id}`];
          if (pauseInfo) {
            l.pause_tracking_aktiv = pauseInfo.pause_tracking_aktiv;
            l.pause_verbleibende_minuten = pauseInfo.pause_verbleibende_minuten;
          }
        });

        const relevanteTermine = termine.filter(t => {
          const istIntern = t.ist_intern === 1 || t.ist_intern === true || t.ist_intern === '1';
          return !istIntern &&
            t.arbeit !== 'Fahrzeug aus Import' &&
            t.arbeit !== 'Fahrzeug hinzugef√ºgt';
        });

        // Arbeitszeiten f√ºr heute laden (f√ºr alle Mitarbeiter und Lehrlinge)
        const arbeitszeitenPromises = [
          ...aktiveMitarbeiter.map(m => 
            ApiService.get(`/arbeitszeiten-plan/for-date?mitarbeiter_id=${m.id}&datum=${heute}`)
              .then(data => ({ type: 'mitarbeiter', id: m.id, data }))
              .catch(() => ({ type: 'mitarbeiter', id: m.id, data: null }))
          ),
          ...aktiveLehrlinge.map(l =>
            ApiService.get(`/arbeitszeiten-plan/for-date?lehrling_id=${l.id}&datum=${heute}`)
              .then(data => ({ type: 'lehrling', id: l.id, data }))
              .catch(() => ({ type: 'lehrling', id: l.id, data: null }))
          )
        ];

        const arbeitszeitenResults = await Promise.all(arbeitszeitenPromises);
        
        // Map f√ºr schnellen Zugriff auf Arbeitszeiten
        const arbeitszeitenMap = {};
        arbeitszeitenResults.forEach(result => {
          const key = `${result.type}_${result.id}`;
          arbeitszeitenMap[key] = result.data;
          // Debug: Log der Arbeitszeit-Daten
          if (result.data) {
            console.log(`[Arbeitszeit] ${key}:`, result.data.arbeitszeit_start, '-', result.data.arbeitszeit_ende);
          }
        });

        // Alle Personen in einem Grid rendern (Mitarbeiter zuerst, dann Lehrlinge)
        let allKacheln = [];

        // Mitarbeiter Kacheln
        aktiveMitarbeiter.forEach(m => {
          const arbeitszeit = arbeitszeitenMap[`mitarbeiter_${m.id}`];
          allKacheln.push(renderPersonKachel(m, relevanteTermine, 'mitarbeiter', globaleNebenzeit, arbeitszeit));
        });

        // Lehrlinge Kacheln
        aktiveLehrlinge.forEach(l => {
          const arbeitszeit = arbeitszeitenMap[`lehrling_${l.id}`];
          allKacheln.push(renderPersonKachel(l, relevanteTermine, 'lehrling', globaleNebenzeit, arbeitszeit));
        });

        if (allKacheln.length > 0) {
          teamGrid.innerHTML = allKacheln.join('');
        } else {
          teamGrid.innerHTML = '<div class="keine-daten">Keine aktiven Mitarbeiter oder Lehrlinge</div>';
        }

      } catch (error) {
        console.error('Fehler beim Laden:', error);
        teamGrid.innerHTML = `
          <div class="error-message">
            <p>‚ö†Ô∏è Fehler beim Laden der Daten</p>
            <p style="font-size: 0.9em; margin-top: 10px;">${escapeHtml(error.message)}</p>
            <p style="font-size: 0.8em; margin-top: 5px; color: var(--text-muted);">Backend: ${CONFIG.backendUrl}</p>
          </div>
        `;
      }
    }

    // ========== UHR & DATUM ==========
    function updateClock() {
      const now = new Date();
      document.getElementById('headerTime').textContent =
        `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

      const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
      document.getElementById('headerDate').textContent = now.toLocaleDateString('de-DE', options);
    }

    // ========== EINSTELLUNGEN ==========
    let isElectron = false;

    async function openSettings() {
      document.getElementById('settingsBackendUrl').value = CONFIG.backendUrl;
      document.getElementById('settingsRefreshInterval').value = CONFIG.refreshInterval;
      document.getElementById('settingsFullscreen').checked = CONFIG.fullscreen !== false;
      document.getElementById('settingsAutostart').checked = CONFIG.autostart === true;
      document.getElementById('settingsDisplayOffTime').value = CONFIG.displayOffTime || '18:10';
      document.getElementById('settingsDisplayOnTime').value = CONFIG.displayOnTime || '07:30';

      // Autostart-Option nur in Electron anzeigen
      document.getElementById('autostartOption').style.display = isElectron ? 'block' : 'none';

      // Config-Pfad anzeigen (nur in Electron)
      if (isElectron && window.electronAPI) {
        try {
          const configPath = await window.electronAPI.getConfigPath();
          document.getElementById('configPathDisplay').textContent = configPath;
          document.getElementById('configPathInfo').style.display = 'block';
        } catch (e) {
          document.getElementById('configPathInfo').style.display = 'none';
        }
      } else {
        document.getElementById('configPathInfo').style.display = 'none';
      }

      document.getElementById('settingsModal').style.display = 'flex';
    }

    function closeSettings() {
      document.getElementById('settingsModal').style.display = 'none';
    }

    async function saveSettings() {
      const newConfig = {
        backendUrl: document.getElementById('settingsBackendUrl').value.trim(),
        refreshInterval: parseInt(document.getElementById('settingsRefreshInterval').value) || 30,
        fullscreen: document.getElementById('settingsFullscreen').checked,
        autostart: document.getElementById('settingsAutostart').checked,
        displayOffTime: document.getElementById('settingsDisplayOffTime').value,
        displayOnTime: document.getElementById('settingsDisplayOnTime').value
      };

      // In Electron: √úber die API speichern
      if (isElectron && window.electronAPI) {
        try {
          CONFIG = await window.electronAPI.saveConfig(newConfig);
          console.log('Konfiguration gespeichert (Electron)');
        } catch (e) {
          console.error('Fehler beim Speichern:', e);
        }
      } else {
        // Browser: In localStorage speichern
        CONFIG = { ...CONFIG, ...newConfig };
        localStorage.setItem('werkstatt-intern-config', JSON.stringify(CONFIG));
      }

      closeSettings();
      loadTeamUebersicht();

      // Refresh-Intervall neu starten
      if (window.refreshIntervalId) clearInterval(window.refreshIntervalId);
      window.refreshIntervalId = setInterval(loadTeamUebersicht, CONFIG.refreshInterval * 1000);
    }

    // ========== INITIALISIERUNG ==========
    document.addEventListener('DOMContentLoaded', async () => {
      // Electron-Konfiguration laden (falls vorhanden)
      await initConfig();

      // Uhr starten
      updateClock();
      setInterval(updateClock, 1000);

      // Daten laden
      loadTeamUebersicht();

      // Auto-Refresh
      window.refreshIntervalId = setInterval(loadTeamUebersicht, CONFIG.refreshInterval * 1000);

      // Event Listener
      document.getElementById('btnRefresh').addEventListener('click', loadTeamUebersicht);
      document.getElementById('btnSettings').addEventListener('click', openSettings);
      document.getElementById('btnSettingsCancel').addEventListener('click', closeSettings);
      document.getElementById('btnSettingsSave').addEventListener('click', saveSettings);

      // Info anzeigen wenn im Browser
      if (!isElectron) {
        console.log('L√§uft im Browser-Modus. F√ºr Autostart die Electron-App verwenden.');
      }
    });
  </script>
</body>
</html>
